<script type="text/javascript" src="libs/papaparse/papaparse.min.js"></script>
<script type="text/javascript" src="ddfcsv.js"></script>
<script type="text/javascript">

	let ddfcsv = Object.create(ddfcsvReader);
	ddfcsv.loadDataset("data/ddf--pcbs--census-master/datapackage.json")
		.then(performQuery)
		.then(console.log);

	function performQuery() {
	
		const queries = [{
			select: {
				key: ["governorate", "year"],
				value: ["buildings"]
			},
			from: "datapoints",
			where: {
				year: { $lt: "2017" },
				connection_to_electricity: { $lt: 26399 }
			}
		},{
			select: {
				key: ["key", "value"],
				value: []
			},
			from: "*.schema"
		},{
			select: {
				key: ["geo"],
				value: ["name","region","is--region","is--country"]
			},
			from: "entities",
			where: {
				$or: [
					{region: "1" },
					{region: "2" }
				]
			}
		},{
			select: {
				key: ["region"],
				value: ["name","is--region","is--country"]
			},
			from: "entities"
		},{
			select: {
				key: ["governorate", "year"],
				value: ["buildings"]
			},
			from: "datapoints",
			where: {
				"governorate": { $in: ["1101","1105","1110","1120","1125"] },
				$or: [
					{"buildings": { $lte: 32833 }},
					{"buildings": { $gte: 50000 }}
				]
			}
		},{
			select: {
				key: ["governorate", "year"],
				value: ["buildings"]
			},
			from: "datapoints",
			where: {
				governorate: "$gov"
			},
			join: {
				$gov: {
					key: "governorate",
					where: {
						"$or": [
							{"region": "1"},
							{"region": { "$eq": "2" } }
						]
					}
				}
			}
		},{
			select: {
				key: ["governorate", "year"],
				value: ["buildings"]
			},
			from: "datapoints",
			where: {
				governorate: "$gov",
				year: { $lt: "2017" }
			},
			join: {
				$gov: {
					key: "governorate",
					where: {
						"$or": [
							{"region": "1"},
						]
					}
				}
			}
		}];

		document.addEventListener('readystatechange', ready);
		function ready() {
			if (document.readyState != 'loading') {
				document.getElementById("query").innerHTML = JSON.stringify(queries, null, 2);
			}
		}
		ready();
		console.log(JSON.stringify(queries,null,2));
		return Promise.all(queries.map(ddfcsv.performQuery.bind(ddfcsv))).then(result => { 
			document.getElementById("query").innerHTML += JSON.stringify(result, null, 2);
			return result;
		});
	}

</script>
<body>
<pre id="query">
</pre>
</body>